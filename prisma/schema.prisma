generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Company {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String?  // Bedrijfsnaam
  email       String?
  phone       String?
  address     String?
  city        String?
  postalCode  String?
  country     String   @default("Nederland")
  logo        String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model User {
  id                String  @id @default(cuid())
  email             String  @unique
  name              String?
  passwordHash      String
  company           Company?  // Bedrijfsgegevens in aparte tabel
  vatNumber         String? // BTW-nummer
  kvkNumber         String? // KvK-nummer
  iban              String?
  invoicePrefix     String  @default("FAC")

  // 2FA velden
  twoFactorSecret  String? // TOTP secret key
  twoFactorEnabled Boolean @default(false)
  backupCodes      String? // JSON array van backup codes

  // Time tracking settings
  defaultHourlyRate Decimal? @db.Decimal(10, 2)
  roundingInterval  Int      @default(0) // 0 = geen afronden, 15, 30, 60 minuten

  // Superuser/Admin
  role            UserRole  @default(USER)

  // Subscription
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  
  subscriptionStatus     SubscriptionStatus @default(FREE)
  subscriptionTier        SubscriptionTier   @default(FREE)

  // Manual subscription (admin assigned, bypasses Stripe)
  isManualSubscription      Boolean   @default(false)
  manualSubscriptionExpiresAt DateTime?
  manualSubscriptionNote    String?   // Admin note (e.g., "Influencer deal - @username")

  // Usage tracking
  invoiceCount           Int       @default(0)
  invoiceCountResetAt    DateTime  @default(now())
  
  // Billing
  billingCycle           BillingCycle?
  
  subscriptionEvents     SubscriptionEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customers         Customer[]
  invoices          Invoice[]
  products          Product[]
  emailSettings     EmailSettings?
  projects          Project[]
  timeEntries       TimeEntry[]
  activityTypes     ActivityType[]
  recurringInvoices RecurringInvoice[]

  // BTW relations
  expenses            Expense[]
  vatReports          VATReport[]
  icpEntries          ICPEntry[]
  vendors             Vendor[]
  expenseTrainingData ExpenseTrainingData[]

  // Credit notes
  creditNotes CreditNote[]

  // BTW settings
  vatRegistered Boolean   @default(true)
  vatScheme     VATScheme @default(REGULAR)

  // Mollie payment settings
  mollieApiKey     String?   // Encrypted
  mollieProfileId  String?
  mollieEnabled    Boolean   @default(false)
  mollieTestMode   Boolean   @default(true)

  // Analytics
  businessGoals      BusinessGoal[]
  analyticsSnapshots AnalyticsSnapshot[]

  // NextAuth sessions
  accounts Account[]
  sessions Session[]

  // Invitations
  sentInvitations     Invitation[] @relation("InvitationSender")
  receivedInvitation Invitation?  @relation("InvitationReceiver")
  
  // Audit logs
  auditLogs          AuditLog[]

  // Discount codes created by this user (admin)
  createdDiscountCodes DiscountCode[]

  // Import/Export
  importExportJobs   ImportExportJob[]
  importTemplates    ImportTemplate[]

  // Tax / Inkomstenbelasting
  fiscalSettings    FiscalSettings?
  assets            Asset[]
  taxReports        TaxReport[]

  // Currency settings
  currencySettings  CurrencySettings?
}

model Customer {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  companyName String?
  email       String
  phone       String?

  address    String
  city       String
  postalCode String
  country    String @default("Nederland")

  vatNumber String? // BTW-nummer klant

  paymentTermDays Int     @default(30)
  notes           String?

  // Currency preference
  currencyId String?
  currency   Currency? @relation(fields: [currencyId], references: [id])

  invoices          Invoice[]
  projects          Project[]
  timeEntries       TimeEntry[]
  recurringInvoices RecurringInvoice[]

  // BTW relations
  expenses   Expense[]
  icpEntries ICPEntry[]

  // Credit notes
  creditNotes CreditNote[]

  // BTW info
  vatCountry  String? // Land voor ICP
  vatReversed Boolean @default(false) // Verlegd BTW van toepassing

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Product {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?
  unitPrice   Decimal @db.Decimal(10, 2)
  vatRate     Decimal @default(21.00) @db.Decimal(5, 2) // 21%, 9%, 0%
  unit        String  @default("uur") // uur, stuk, dag, etc.
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Invoice {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  invoiceNumber String   @unique
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])

  invoiceDate DateTime      @default(now())
  dueDate     DateTime
  status      InvoiceStatus @default(DRAFT)

  // Bedragen
  subtotal  Decimal @db.Decimal(10, 2)
  vatAmount Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  // Currency (multi-currency support)
  currencyId         String?
  currency           Currency?   @relation(fields: [currencyId], references: [id])
  currencyCode       String      @default("EUR")

  // Exchange rate info (locked on send)
  exchangeRate       Decimal?    @db.Decimal(12, 6)
  exchangeRateDate   DateTime?   @db.Date
  exchangeRateSource RateSource?
  exchangeRateLocked Boolean     @default(false)

  // EUR equivalents (for bookkeeping/VAT reporting)
  subtotalEur        Decimal?    @db.Decimal(10, 2)
  vatAmountEur       Decimal?    @db.Decimal(10, 2)
  totalEur           Decimal?    @db.Decimal(10, 2)

  // Extra velden
  reference     String? // Referentie klant
  notes         String? // Extra notities op factuur
  internalNotes String? // Interne notities (niet op PDF)

  // Items
  items InvoiceItem[]

  // Metadata
  pdfPath String?
  sentAt  DateTime?
  paidAt  DateTime?

  // Email tracking
  emails          EmailLog[]
  emailsSentCount Int        @default(0)
  lastEmailSentAt DateTime?

  // Recurring invoice relation
  recurringInvoiceId String?
  recurringInvoice   RecurringInvoice? @relation(fields: [recurringInvoiceId], references: [id])

  // Mollie payment link
  paymentLinkToken     String?   @unique
  paymentLinkExpiresAt DateTime?
  payments             Payment[]

  // Credit notes linked to this invoice
  creditNotes CreditNote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([customerId])
  @@index([status])
  @@index([invoiceDate])
  @@index([recurringInvoiceId])
  @@index([paymentLinkToken])
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(10, 2)
  vatRate     Decimal @db.Decimal(5, 2)
  unit        String  @default("uur")

  // Berekend
  subtotal  Decimal @db.Decimal(10, 2) // quantity * unitPrice
  vatAmount Decimal @db.Decimal(10, 2) // subtotal * (vatRate / 100)
  total     Decimal @db.Decimal(10, 2) // subtotal + vatAmount

  sortOrder Int @default(0)

  // Time tracking relation (optional)
  timeEntry TimeEntry? @relation("TimeEntryToInvoiceItem")

  // Expense relation (optional)
  expense Expense?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
}

enum InvoiceStatus {
  DRAFT // Concept
  SENT // Verzonden
  PAID // Betaald
  OVERDUE // Achterstallig
  CANCELLED // Geannuleerd
}

// Mollie Payment Models

model Payment {
  id              String    @id @default(cuid())
  invoiceId       String
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  molliePaymentId String    @unique
  mollieStatus    String    // open, pending, paid, failed, canceled, expired
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("EUR")
  method          String?   // ideal, bancontact, creditcard, etc.

  consumerName    String?
  consumerAccount String?   // IBAN

  paidAt          DateTime?
  expiresAt       DateTime?

  metadata        Json?

  events          PaymentEvent[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([invoiceId])
  @@index([mollieStatus])
  @@index([createdAt])
}

model PaymentEvent {
  id          String           @id @default(cuid())
  paymentId   String
  payment     Payment          @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  eventType   PaymentEventType
  mollieStatus String?
  metadata    Json?

  createdAt   DateTime         @default(now())

  @@index([paymentId])
  @@index([eventType])
  @@index([createdAt])
}

enum PaymentEventType {
  PAYMENT_CREATED
  PAYMENT_PAID
  PAYMENT_FAILED
  PAYMENT_CANCELED
  PAYMENT_EXPIRED
  WEBHOOK_RECEIVED
}

enum EmailType {
  INVOICE // Nieuwe factuur
  REMINDER_FRIENDLY // Vriendelijke herinnering (voor vervaldatum)
  REMINDER_FIRST // 1e herinnering (na vervaldatum)
  REMINDER_SECOND // 2e herinnering
  REMINDER_FINAL // Finale herinnering
  PAYMENT_RECEIVED // Betaling ontvangen bevestiging
  CREDIT_NOTE // Credit nota
}

// Credit Note Enums

enum CreditNoteStatus {
  DRAFT // Concept
  FINAL // Definitief (vergrendeld)
  SENT // Verzonden
  PROCESSED // Verwerkt
  REFUNDED // Terugbetaald
}

enum CreditNoteReason {
  PRICE_CORRECTION // Prijscorrectie
  QUANTITY_CORRECTION // Aantalaanpassing
  RETURN // Retour
  CANCELLATION // Annulering
  DISCOUNT_AFTER // Korting achteraf
  VAT_CORRECTION // BTW correctie
  DUPLICATE_INVOICE // Dubbele factuur
  GOODWILL // Coulance
  OTHER // Overig
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  FAILED
  BOUNCED
}

model EmailLog {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  type      EmailType
  recipient String
  subject   String
  status    EmailStatus @default(PENDING)

  resendId String? // Resend email ID voor tracking
  error    String?

  sentAt    DateTime?
  openedAt  DateTime? // Via Resend webhooks
  clickedAt DateTime? // Via Resend webhooks

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([status])
  @@index([type])
}

model EmailSettings {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Auto-send settings
  autoSendInvoice        Boolean @default(false)
  autoSendReminders      Boolean @default(false)
  autoSendPaymentConfirm Boolean @default(true)

  // Reminder timing
  friendlyReminderDays Int @default(-3) // 3 dagen voor vervaldatum
  firstReminderDays    Int @default(7) // 7 dagen na vervaldatum
  secondReminderDays   Int @default(14)
  finalReminderDays    Int @default(30)

  // Template customization
  companyLogo    String?
  emailSignature String?
  invoiceEmailCc String? // CC alle factuur emails

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Credit Note Models

model CreditNote {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  creditNoteNumber String @unique
  customerId       String
  customer         Customer @relation(fields: [customerId], references: [id])

  creditNoteDate DateTime         @default(now())
  status         CreditNoteStatus @default(DRAFT)
  reason         CreditNoteReason

  // Link to original invoice (optional)
  originalInvoiceId     String?
  originalInvoice       Invoice? @relation(fields: [originalInvoiceId], references: [id])
  originalInvoiceNumber String?

  // Amounts
  subtotal  Decimal @db.Decimal(10, 2)
  vatAmount Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  // Currency (multi-currency support)
  currencyId         String?
  currency           Currency?   @relation(fields: [currencyId], references: [id])
  currencyCode       String      @default("EUR")

  // Exchange rate info
  exchangeRate       Decimal?    @db.Decimal(12, 6)
  exchangeRateDate   DateTime?   @db.Date
  exchangeRateSource RateSource?

  // EUR equivalents (for bookkeeping/VAT reporting)
  subtotalEur        Decimal?    @db.Decimal(10, 2)
  vatAmountEur       Decimal?    @db.Decimal(10, 2)
  totalEur           Decimal?    @db.Decimal(10, 2)

  // Extra velden
  description   String?
  notes         String? // Notities op credit nota
  internalNotes String? // Interne notities (niet op PDF)

  // Items
  items CreditNoteItem[]

  // Metadata
  pdfPath     String?
  sentAt      DateTime?
  finalizedAt DateTime?
  processedAt DateTime?
  refundedAt  DateTime?

  // Email tracking
  emails          CreditNoteEmailLog[]
  emailsSentCount Int                  @default(0)
  lastEmailSentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([customerId])
  @@index([status])
  @@index([creditNoteDate])
  @@index([originalInvoiceId])
}

model CreditNoteItem {
  id           String     @id @default(cuid())
  creditNoteId String
  creditNote   CreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)

  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(10, 2)
  vatRate     Decimal @db.Decimal(5, 2)
  unit        String  @default("uur")

  // Berekend
  subtotal  Decimal @db.Decimal(10, 2) // quantity * unitPrice
  vatAmount Decimal @db.Decimal(10, 2) // subtotal * (vatRate / 100)
  total     Decimal @db.Decimal(10, 2) // subtotal + vatAmount

  sortOrder Int @default(0)

  // Link to original invoice item (optional)
  originalInvoiceItemId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creditNoteId])
}

model CreditNoteEmailLog {
  id           String     @id @default(cuid())
  creditNoteId String
  creditNote   CreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)

  type      EmailType
  recipient String
  subject   String
  status    EmailStatus @default(PENDING)

  resendId String? // Resend email ID voor tracking
  error    String?

  sentAt    DateTime?
  openedAt  DateTime? // Via Resend webhooks
  clickedAt DateTime? // Via Resend webhooks

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creditNoteId])
  @@index([status])
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Time Tracking Models

model Project {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  name        String
  description String?
  code        String? // Project code voor referentie
  color       String? // Kleur voor visuele identificatie

  status ProjectStatus @default(ACTIVE)

  // Budget tracking
  budgetHours  Decimal? @db.Decimal(10, 2)
  budgetAmount Decimal? @db.Decimal(10, 2)

  // Default rates
  defaultHourlyRate Decimal? @db.Decimal(10, 2)

  // Dates
  startDate DateTime?
  endDate   DateTime?

  // Relations
  timeEntries TimeEntry[]
  expenses    Expense[]

  // Metadata
  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([customerId])
  @@index([status])
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

model TimeEntry {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  invoiceItemId String?      @unique
  invoiceItem   InvoiceItem? @relation("TimeEntryToInvoiceItem", fields: [invoiceItemId], references: [id])

  // Time tracking
  description String

  startTime DateTime
  endTime   DateTime?

  duration Decimal @db.Decimal(10, 2) // in uren (bijv 1.5 = 1u 30min)

  // Running timer
  isRunning Boolean @default(false)

  // Billing
  billable   Boolean @default(true)
  hourlyRate Decimal @db.Decimal(10, 2)
  amount     Decimal @db.Decimal(10, 2) // duration * hourlyRate

  // Status
  invoiced Boolean @default(false)

  // Metadata
  activityType String? // Development, Meeting, Research, Support, etc.
  notes        String? // Interne notities
  tags         String[] // Voor filtering/grouping

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([customerId])
  @@index([projectId])
  @@index([startTime])
  @@index([billable])
  @@index([invoiced])
  @@index([isRunning])
}

model ActivityType {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?
  color       String?
  icon        String? // Lucide icon name
  billable    Boolean @default(true) // Default billable status

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

// Recurring Invoices Models

model RecurringInvoice {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Naming
  name        String // "Retainer Q1 2025", "Hosting Package"
  description String?
  reference   String? // Contract nummer

  // Scheduling
  frequency RecurringFrequency
  interval  Int                @default(1) // Elke X maanden/weken

  startDate DateTime
  endDate   DateTime?
  nextDate  DateTime // Volgende generatie datum
  lastDate  DateTime? // Laatste keer gegenereerd

  // Status
  status RecurringStatus @default(ACTIVE)

  // Billing details
  dayOfMonth Int? // Voor monthly: dag van de maand (1-28)

  // Auto-send
  autoSend Boolean @default(false)
  sendDays Int     @default(0) // Dagen na generatie voor verzending

  // Currency
  currencyCode String @default("EUR")

  // Items template
  items RecurringInvoiceItem[]

  // Pricing history
  priceChanges RecurringPriceChange[]

  // Generated invoices
  invoices Invoice[]

  // Logs
  logs RecurringInvoiceLog[]

  // Metadata
  notes    String? // Interne notities
  contract String? // PDF path naar contract

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([customerId])
  @@index([status])
  @@index([nextDate])
}

enum RecurringFrequency {
  WEEKLY
  BIWEEKLY // Tweewekelijks
  MONTHLY
  QUARTERLY
  BIANNUAL // Halfjaarlijks
  ANNUAL
}

enum RecurringStatus {
  ACTIVE // Actief, genereert facturen
  PAUSED // Gepauzeerd
  ENDED // Afgelopen (einddatum bereikt)
  CANCELLED // Geannuleerd
}

model RecurringInvoiceItem {
  id                 String           @id @default(cuid())
  recurringInvoiceId String
  recurringInvoice   RecurringInvoice @relation(fields: [recurringInvoiceId], references: [id], onDelete: Cascade)

  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(10, 2)
  vatRate     Decimal @db.Decimal(5, 2)

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recurringInvoiceId])
}

model RecurringPriceChange {
  id                 String           @id @default(cuid())
  recurringInvoiceId String
  recurringInvoice   RecurringInvoice @relation(fields: [recurringInvoiceId], references: [id], onDelete: Cascade)

  effectiveDate DateTime
  oldAmount     Decimal  @db.Decimal(10, 2)
  newAmount     Decimal  @db.Decimal(10, 2)
  reason        String?

  applied   Boolean   @default(false)
  appliedAt DateTime?

  createdBy String // User ID die wijziging maakte
  createdAt DateTime @default(now())

  @@index([recurringInvoiceId])
  @@index([effectiveDate])
}

model RecurringInvoiceLog {
  id                 String           @id @default(cuid())
  recurringInvoiceId String
  recurringInvoice   RecurringInvoice @relation(fields: [recurringInvoiceId], references: [id], onDelete: Cascade)

  action    RecurringLogAction
  invoiceId String? // Als actie een factuur genereerde

  details   String?
  createdBy String? // User ID
  createdAt DateTime @default(now())

  @@index([recurringInvoiceId])
  @@index([createdAt])
}

enum RecurringLogAction {
  CREATED
  ACTIVATED
  PAUSED
  RESUMED
  CANCELLED
  ENDED
  INVOICE_GENERATED
  PRICE_CHANGED
  SCHEDULE_UPDATED
}

// BTW Reporting Models

model Expense {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  date        DateTime
  description String
  category    ExpenseCategory

  // Amounts
  amount    Decimal @db.Decimal(10, 2) // Inclusief BTW
  vatAmount Decimal @db.Decimal(10, 2)
  vatRate   Decimal @db.Decimal(5, 2)
  netAmount Decimal @db.Decimal(10, 2) // Exclusief BTW

  // Supplier info
  supplier      String?
  invoiceNumber String?

  // Vendor relation (for auto-categorization)
  vendorId          String?
  vendor            Vendor?         @relation(fields: [vendorId], references: [id])

  // Categorization tracking
  predictedCategory   ExpenseCategory?
  categorySource      CategorySource?
  wasAutoCategorized  Boolean         @default(false)
  wasCorrected        Boolean         @default(false)

  // Deductibility
  deductible     Boolean @default(true)
  deductiblePerc Decimal @default(100) @db.Decimal(5, 2) // Percentage aftrekbaar

  // Receipt
  receipt String? // File path naar scan/foto

  // Relations
  customerId String? // Als doorbelast aan klant
  customer   Customer? @relation(fields: [customerId], references: [id])

  projectId String? // Koppel aan project
  project   Project? @relation(fields: [projectId], references: [id])

  invoiced      Boolean      @default(false) // Doorbelast op factuur
  invoiceItemId String?      @unique
  invoiceItem   InvoiceItem? @relation(fields: [invoiceItemId], references: [id])

  // Metadata
  notes String?
  tags  String[]

  // OCR Metadata
  ocrStatus      OcrStatus?
  ocrConfidence  Decimal?   @db.Decimal(3, 2) // 0.00-1.00
  ocrExtractedAt DateTime?
  ocrRawData     Json?      // Alle geëxtraheerde data
  ocrError       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([date])
  @@index([category])
  @@index([deductible])
  @@index([vendorId])
}

model Vendor {
  id              String          @id @default(cuid())
  userId          String?         // null = global vendor
  user            User?           @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String          // Display name
  normalizedName  String          // Lowercase for matching
  aliases         String[]        // Alternative names
  defaultCategory ExpenseCategory

  website         String?
  vatNumber       String?

  useCount        Int             @default(0)
  lastUsedAt      DateTime?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  expenses        Expense[]

  @@unique([userId, normalizedName])
  @@index([userId])
  @@index([normalizedName])
}

model ExpenseTrainingData {
  id                 String          @id @default(cuid())
  userId             String
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  supplierName       String?
  normalizedSupplier String?

  predictedCategory  ExpenseCategory
  actualCategory     ExpenseCategory

  expenseId          String?
  createdAt          DateTime        @default(now())

  @@index([userId])
  @@index([normalizedSupplier])
}

enum ExpenseCategory {
  OFFICE // Kantoorkosten
  TRAVEL // Reiskosten
  EQUIPMENT // Apparatuur
  SOFTWARE // Software/subscriptions
  MARKETING // Marketing
  EDUCATION // Opleiding
  INSURANCE // Verzekeringen
  ACCOUNTANT // Accountant/administratie
  TELECOM // Telefoon/internet
  UTILITIES // Energie
  RENT // Huur
  MAINTENANCE // Onderhoud
  PROFESSIONAL // Professionele diensten
  OTHER // Overig
}

enum OcrStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

enum CategorySource {
  MANUAL
  VENDOR_MATCH
  KEYWORD_MATCH
  AI_PREDICTION
}

model VATReport {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Period
  year      Int
  quarter   Int // 1, 2, 3, 4
  startDate DateTime
  endDate   DateTime

  // Revenue (Omzet)
  revenueHighRate Decimal @db.Decimal(10, 2) // 21%
  revenueHighVAT  Decimal @db.Decimal(10, 2)

  revenueLowRate Decimal @db.Decimal(10, 2) // 9%
  revenueLowVAT  Decimal @db.Decimal(10, 2)

  revenueZeroRate Decimal @db.Decimal(10, 2) // 0%

  revenueReversed Decimal @db.Decimal(10, 2) // Verlegd
  revenueEU       Decimal @db.Decimal(10, 2) // ICP
  revenueExport   Decimal @db.Decimal(10, 2) // Export buiten EU

  totalRevenue    Decimal @db.Decimal(10, 2)
  totalRevenueVAT Decimal @db.Decimal(10, 2)

  // Expenses (Inkopen/Kosten)
  expensesHighRate Decimal @db.Decimal(10, 2)
  expensesHighVAT  Decimal @db.Decimal(10, 2)

  expensesLowRate Decimal @db.Decimal(10, 2)
  expensesLowVAT  Decimal @db.Decimal(10, 2)

  expensesReversed Decimal @db.Decimal(10, 2) // Verlegd ontvangen

  totalExpenses    Decimal @db.Decimal(10, 2)
  totalExpensesVAT Decimal @db.Decimal(10, 2)

  // Calculation
  vatOwed       Decimal @db.Decimal(10, 2) // Te betalen
  vatDeductible Decimal @db.Decimal(10, 2) // Aftrekbaar
  vatBalance    Decimal @db.Decimal(10, 2) // Saldo (owes - deductible)

  // Status
  status    VATReportStatus @default(DRAFT)
  filedDate DateTime?

  // Adjustments/Corrections
  adjustments VATAdjustment[]

  // Metadata
  notes       String?
  generatedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, year, quarter])
  @@index([userId])
  @@index([year, quarter])
}

enum VATReportStatus {
  DRAFT
  FINAL
  FILED // Ingediend bij Belastingdienst
}

model VATAdjustment {
  id       String    @id @default(cuid())
  reportId String
  report   VATReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  description String
  amount      Decimal @db.Decimal(10, 2)
  reason      String?

  createdAt DateTime @default(now())

  @@index([reportId])
}

model ICPEntry {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Period
  year    Int
  quarter Int

  // Customer (EU business)
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Amounts
  amount Decimal @db.Decimal(10, 2) // Totaal voor deze klant dit kwartaal

  // Metadata
  invoiceIds String[] // Factuur IDs voor referentie

  createdAt DateTime @default(now())

  @@unique([userId, year, quarter, customerId])
  @@index([userId])
  @@index([year, quarter])
  @@index([customerId])
}

enum VATScheme {
  REGULAR // Reguliere regeling
  SMALL // Kleine ondernemersregeling (KOR)
  MARGIN // Margeregeling
}

// Analytics Models

model BusinessGoal {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type   GoalType
  period GoalPeriod

  // Target values
  targetRevenue Decimal? @db.Decimal(10, 2)
  targetProfit  Decimal? @db.Decimal(10, 2)
  targetHours   Decimal? @db.Decimal(10, 2)
  targetClients Int?

  // Period
  year    Int
  quarter Int? // Voor quarterly goals
  month   Int? // Voor monthly goals

  // Tracking
  achieved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type, period, year, quarter, month])
  @@index([userId])
}

enum GoalType {
  REVENUE
  PROFIT
  HOURS
  CLIENTS
}

enum GoalPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

model AnalyticsSnapshot {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date DateTime

  // Daily metrics
  revenue  Decimal @db.Decimal(10, 2)
  expenses Decimal @db.Decimal(10, 2)
  profit   Decimal @db.Decimal(10, 2)

  // Counts
  invoicesSent   Int
  invoicesPaid   Int
  newCustomers   Int
  activeProjects Int

  // Hours
  hoursLogged   Decimal @db.Decimal(10, 2)
  billableHours Decimal @db.Decimal(10, 2)

  // Outstanding
  outstanding Decimal @db.Decimal(10, 2)
  overdue     Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

enum UserRole {
  USER
  ADMIN
  SUPERUSER
}

enum SubscriptionStatus {
  FREE
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

enum SubscriptionTier {
  FREE
  PRO          // Legacy - mapped to PROFESSIONAL
  STARTER
  PROFESSIONAL
  BUSINESS
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionEventType {
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_DELETED
  SUBSCRIPTION_TRIAL_ENDING
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  INVOICE_PAID
  INVOICE_PAYMENT_FAILED
}

enum WatermarkPosition {
  DIAGONAL      // Diagonaal over de pagina
  CENTER        // Gecentreerd
  BOTTOM        // Onderaan
  TOP           // Bovenaan
  FOOTER        // In footer sectie
}

model SystemSettings {
  id          String   @id @default("default")

  // Watermark settings
  watermarkEnabled        Boolean  @default(true)
  watermarkText           String   @default("GRATIS VERSIE - Upgrade naar Pro op app.yoursite.com")
  watermarkOpacity        Decimal  @db.Decimal(3, 2) @default(0.15)
  watermarkRotation       Int      @default(-45) // degrees
  watermarkFontSize       Int      @default(40)
  watermarkColor          String   @default("#999999")
  watermarkPosition       WatermarkPosition @default(DIAGONAL)

  // Feature toggles
  freeUserWatermarkEnabled Boolean @default(true)

  // Metadata
  updatedAt   DateTime @updatedAt
  updatedBy   String?  // User ID who made the change

  @@unique([id]) // Ensure only one settings record
}

model SubscriptionEvent {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        SubscriptionEventType
  
  // Stripe data
  stripeEventId String  @unique
  
  // Metadata
  metadata    Json?
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// User Invitations Model

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

model Invitation {
  id          String   @id @default(cuid())

  // Sender (admin/owner)
  senderId    String
  sender      User     @relation("InvitationSender", fields: [senderId], references: [id], onDelete: Cascade)

  // Receiver (invited user)
  receiverId  String?  @unique
  receiver    User?    @relation("InvitationReceiver", fields: [receiverId], references: [id], onDelete: SetNull)

  // Invitation details
  email       String
  token       String   @unique // Unique token for invitation link
  status      InvitationStatus @default(PENDING)

  // Role for the invited user
  role        UserRole @default(USER)

  // Subscription tier to assign (admin feature)
  subscriptionTier       SubscriptionTier?
  subscriptionDuration   Int?      // Duration in months (null = unlimited)

  // Expiration
  expiresAt   DateTime
  acceptedAt  DateTime?

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([senderId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
}

// Discount Codes for promotions (influencers, campaigns)
model DiscountCode {
  id          String   @id @default(cuid())

  // Code details
  code        String   @unique // e.g., "INFLUENCER20", "LAUNCH50"
  description String?           // Internal description

  // Discount configuration
  discountType    DiscountType
  discountValue   Int              // Percentage (10 = 10%) or fixed amount in cents (1000 = €10)

  // Restrictions
  maxUses         Int?             // null = unlimited
  usedCount       Int      @default(0)
  minTier         SubscriptionTier @default(STARTER) // Minimum tier required
  validForTiers   String?          // JSON array of valid tiers, null = all

  // Validity period
  validFrom       DateTime @default(now())
  validUntil      DateTime?        // null = no expiration
  isActive        Boolean  @default(true)

  // Tracking
  createdById     String
  createdBy       User     @relation(fields: [createdById], references: [id])

  // Campaign/source tracking
  campaign        String?          // e.g., "instagram_q1_2025"
  source          String?          // e.g., "@influencer_username"

  // Usage records
  usages          DiscountCodeUsage[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([code])
  @@index([isActive])
  @@index([validFrom])
  @@index([validUntil])
  @@index([campaign])
}

model DiscountCodeUsage {
  id              String   @id @default(cuid())

  discountCodeId  String
  discountCode    DiscountCode @relation(fields: [discountCodeId], references: [id], onDelete: Cascade)

  userId          String
  appliedAt       DateTime @default(now())

  // Snapshot of discount applied
  discountAmount  Int      // Amount in cents that was discounted
  originalAmount  Int      // Original amount before discount
  finalAmount     Int      // Final amount after discount

  // Stripe reference
  stripeInvoiceId String?

  @@index([discountCodeId])
  @@index([userId])
  @@index([appliedAt])
}

enum DiscountType {
  PERCENTAGE    // e.g., 20% off
  FIXED_AMOUNT  // e.g., €10 off
}

// Audit Trail Model
model AuditLog {
  id          String   @id @default(cuid())
  timestamp   DateTime @default(now())
  
  // User information (snapshot for deleted users)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userEmail   String   // Snapshot of email at time of action
  
  // Action details
  action      AuditAction
  entityType  String   // invoice, customer, product, settings, etc.
  entityId    String?  // ID of the affected record
  
  // Change tracking
  changes     Json?    // { field: { oldValue, newValue } }
  
  // Request context
  ipAddress   String?
  userAgent   String?
  sessionId   String?
  
  // Additional metadata
  metadata    Json?    // Extra context (export format, print action, etc.)
  
  // Compliance features
  previousHash String? // Hash of previous log entry for chain integrity
  hash         String  // Hash of this log entry
  
  // Fraud detection flags
  isSuspicious Boolean @default(false)
  suspiciousReason String?
  
  createdAt   DateTime @default(now())
  
  @@index([timestamp])
  @@index([userId])
  @@index([userEmail])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([entityType, entityId])
  @@index([isSuspicious])
  @@index([createdAt])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PAYMENT_RECORDED
  INVOICE_SENT
  CREDIT_NOTE_SENT
  CREDIT_NOTE_FINALIZED
  CREDIT_NOTE_REFUNDED
  SETTINGS_CHANGED
  PASSWORD_CHANGED
  TWO_FA_ENABLED
  TWO_FA_DISABLED
}

// Import/Export Models

enum ImportExportType {
  IMPORT
  EXPORT
}

enum ImportExportEntityType {
  CUSTOMERS
  INVOICES
  EXPENSES
  PRODUCTS
  TIME_ENTRIES
}

enum ImportExportJobStatus {
  PENDING
  VALIDATING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model ImportExportJob {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Job type
  type       ImportExportType
  entityType ImportExportEntityType

  // Status
  status ImportExportJobStatus @default(PENDING)

  // File info (fileContent preferred; filePath only for legacy temp files)
  fileName    String?
  filePath    String?
  fileContent Bytes?  // Stored in DB so no temp file on disk after upload
  fileSize    Int?
  mimeType    String?

  // Import specifiek
  columnMapping Json? // { fileColumn: systemField }
  importOptions Json? // { skipDuplicates, updateExisting, etc }

  // Export specifiek
  exportOptions Json? // { format, filters, columns }
  exportFilters Json? // Welke records exporteren

  // Resultaten
  totalRows     Int?
  processedRows Int?
  successRows   Int?
  errorRows     Int?
  skippedRows   Int?

  // Errors & warnings
  errors   Json? // [{ row, field, message }]
  warnings Json? // [{ row, field, message }]

  // Timing
  startedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model ImportTemplate {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Template info
  name       String
  entityType ImportExportEntityType

  // Mapping
  columnMapping Json // { fileColumn: systemField }

  // Opties
  options Json?

  // Gebruik tracking
  lastUsedAt DateTime?
  useCount   Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([entityType])
}

// ========== Tax / Inkomstenbelasting Models ==========

// Fiscale instellingen per gebruiker
model FiscalSettings {
  id                   String          @id @default(cuid())
  userId               String          @unique
  user                 User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessType         BusinessType    @default(EENMANSZAAK)
  useKOR               Boolean         @default(false) // Kleineondernemersregeling (geen BTW)
  hoursTracked         Boolean         @default(false) // Wordt urencriterium bijgehouden via tijdregistratie?
  manualHoursPerYear   Int?            // Handmatig ingevoerde uren per jaar
  isStarter            Boolean         @default(false)
  starterYearsUsed     Int             @default(0) // Hoeveel jaren startersaftrek gebruikt
  firstStarterYear     Int?            // Eerste jaar dat startersaftrek is toegepast
  hasHomeOffice        Boolean         @default(false)
  homeOfficeType       HomeOfficeType?
  homeOfficePercentage Decimal?        @db.Decimal(5, 2) // Percentage van woning zakelijk
  hasBusinessCar       Boolean         @default(false)
  carPrivateUsage      Decimal?        @db.Decimal(5, 2) // Percentage privé gebruik
  useFOR               Boolean         @default(false) // Fiscale Oudedagsreserve

  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
}

enum BusinessType {
  EENMANSZAAK
  VOF
  MAATSCHAP
  BV
}

enum HomeOfficeType {
  INDEPENDENT     // Zelfstandige werkruimte
  NON_INDEPENDENT // Niet-zelfstandige werkruimte
}

// Bedrijfsmiddelen (activa)
model Asset {
  id                 String              @id @default(cuid())
  userId             String
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  name               String
  description        String?
  category           AssetCategory
  purchaseDate       DateTime
  purchasePrice      Decimal             @db.Decimal(10, 2)
  supplier           String?
  usefulLifeYears    Int                 // Afschrijvingstermijn in jaren
  residualValue      Decimal             @default(0) @db.Decimal(10, 2) // Restwaarde
  depreciationMethod DepreciationMethod  @default(LINEAR)
  bookValue          Decimal             @db.Decimal(10, 2) // Huidige boekwaarde
  isActive           Boolean             @default(true)
  disposalDate       DateTime?           // Datum verkoop/afschrijving
  disposalPrice      Decimal?            @db.Decimal(10, 2) // Verkoopprijs
  kiaApplied         Boolean             @default(false) // KIA toegepast?
  kiaYear            Int?                // Jaar waarin KIA is toegepast

  depreciationEntries DepreciationEntry[]

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@index([userId])
  @@index([category])
  @@index([isActive])
}

enum AssetCategory {
  EQUIPMENT   // Apparatuur/machines
  VEHICLE     // Voertuigen
  FURNITURE   // Inventaris/meubilair
  SOFTWARE    // Software/licenties
  BUILDING    // Gebouwen
  INTANGIBLE  // Immaterieel (goodwill, etc.)
  OTHER       // Overig
}

enum DepreciationMethod {
  LINEAR      // Lineair (gelijke bedragen)
  DEGRESSIVE  // Degressief (dalende bedragen)
}

// Afschrijvingen per jaar
model DepreciationEntry {
  id             String   @id @default(cuid())
  assetId        String
  asset          Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  year           Int
  amount         Decimal  @db.Decimal(10, 2)
  bookValueStart Decimal  @db.Decimal(10, 2)
  bookValueEnd   Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now())

  @@unique([assetId, year])
  @@index([year])
}

// Jaarlijks belastingrapport
model TaxReport {
  id                     String          @id @default(cuid())
  userId                 String
  user                   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  year                   Int
  status                 TaxReportStatus @default(DRAFT)

  // Omzet
  revenueGross           Decimal         @db.Decimal(10, 2) // Bruto omzet
  creditNotesTotal       Decimal         @db.Decimal(10, 2) // Credit nota's
  revenueNet             Decimal         @db.Decimal(10, 2) // Netto omzet

  // Kosten per categorie
  expensesTransport      Decimal         @db.Decimal(10, 2) // Vervoerskosten
  expensesHousing        Decimal         @db.Decimal(10, 2) // Huisvestingskosten
  expensesGeneral        Decimal         @db.Decimal(10, 2) // Algemene kosten
  expensesOffice         Decimal         @db.Decimal(10, 2) // Kantoorkosten
  expensesOutsourced     Decimal         @db.Decimal(10, 2) // Uitbesteed werk
  expensesRepresentation Decimal         @db.Decimal(10, 2) // Representatiekosten
  expensesOther          Decimal         @db.Decimal(10, 2) // Overige kosten
  expensesTotal          Decimal         @db.Decimal(10, 2) // Totaal kosten

  // Afschrijvingen & winst
  depreciationTotal      Decimal         @db.Decimal(10, 2) // Totaal afschrijvingen
  grossProfit            Decimal         @db.Decimal(10, 2) // Bruto winst

  // Aftrekposten
  kiaAmount              Decimal         @db.Decimal(10, 2) // Kleinschaligheidsinvesteringsaftrek
  kiaInvestments         Decimal         @db.Decimal(10, 2) // Investeringen voor KIA
  zelfstandigenaftrek    Decimal         @db.Decimal(10, 2) // Zelfstandigenaftrek
  startersaftrek         Decimal         @db.Decimal(10, 2) // Startersaftrek
  forDotation            Decimal         @db.Decimal(10, 2) // FOR dotatie

  // Eindberekening
  profitBeforeMKB        Decimal         @db.Decimal(10, 2) // Winst voor MKB-vrijstelling
  mkbVrijstelling        Decimal         @db.Decimal(10, 2) // MKB-winstvrijstelling
  taxableProfit          Decimal         @db.Decimal(10, 2) // Belastbaar inkomen
  estimatedTaxBox1       Decimal         @db.Decimal(10, 2) // Geschatte belasting box 1

  // Uren
  hoursWorked            Int?            // Gewerkte uren
  meetsHoursCriterion    Boolean         @default(false) // Voldoet aan urencriterium

  generatedAt            DateTime        @default(now())
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  @@unique([userId, year])
  @@index([userId])
  @@index([year])
}

enum TaxReportStatus {
  DRAFT       // Concept
  PROVISIONAL // Voorlopig
  FINAL       // Definitief
  FILED       // Ingediend bij Belastingdienst
}

// ========== Multi-Currency Models ==========

model Currency {
  id              String         @id @default(cuid())
  code            String         @unique // EUR, USD, GBP
  name            String         // Euro, US Dollar
  nameDutch       String         // Euro, Amerikaanse Dollar
  symbol          String         // €, $, £
  symbolPosition  SymbolPosition @default(BEFORE)
  decimalPlaces   Int            @default(2) // 0 for JPY
  isActive        Boolean        @default(true)
  isDefault       Boolean        @default(false) // EUR
  sortOrder       Int            @default(0)

  exchangeRates   ExchangeRate[]
  customers       Customer[]
  invoices        Invoice[]
  creditNotes     CreditNote[]
  userSettings    CurrencySettings[] @relation("EnabledCurrencies")
  baseSettings    CurrencySettings[] @relation("BaseCurrency")

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

enum SymbolPosition {
  BEFORE // € 100
  AFTER  // 100 kr
}

model ExchangeRate {
  id           String     @id @default(cuid())
  currencyId   String
  currency     Currency   @relation(fields: [currencyId], references: [id])
  currencyCode String     // Denormalized for queries

  date         DateTime   @db.Date
  rate         Decimal    @db.Decimal(12, 6) // 1 EUR = X foreign
  inverseRate  Decimal    @db.Decimal(12, 6) // 1 foreign = X EUR
  source       RateSource @default(ECB)

  createdAt    DateTime   @default(now())

  @@unique([currencyCode, date])
  @@index([currencyCode])
  @@index([date])
}

enum RateSource {
  ECB    // European Central Bank
  MANUAL // Manual override
}

model CurrencySettings {
  id                String          @id @default(cuid())
  userId            String          @unique
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  baseCurrencyId    String
  baseCurrency      Currency        @relation("BaseCurrency", fields: [baseCurrencyId], references: [id])

  enabledCurrencies Currency[]      @relation("EnabledCurrencies")

  autoFetchRates    Boolean         @default(true)
  lockRateOn        RateLockTiming  @default(SEND)
  showBaseEquivalent Boolean        @default(true)

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

enum RateLockTiming {
  CREATE // When invoice is created
  SEND   // When invoice is sent (default)
  MANUAL // Only manually
}
