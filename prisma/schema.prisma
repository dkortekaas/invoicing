generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String  @id @default(cuid())
  email             String  @unique
  name              String?
  passwordHash      String
  companyName       String
  companyEmail      String
  companyPhone      String?
  companyAddress    String
  companyCity       String
  companyPostalCode String
  companyCountry    String  @default("Nederland")
  companyLogo       String? // Logo URL/path
  vatNumber         String? // BTW-nummer
  kvkNumber         String? // KvK-nummer
  iban              String?
  invoicePrefix     String  @default("FAC")

  // 2FA velden
  twoFactorSecret  String? // TOTP secret key
  twoFactorEnabled Boolean @default(false)
  backupCodes      String? // JSON array van backup codes

  // Time tracking settings
  defaultHourlyRate Decimal? @db.Decimal(10, 2)
  roundingInterval  Int      @default(0) // 0 = geen afronden, 15, 30, 60 minuten

  // Superuser/Admin
  role            UserRole  @default(USER)

  // Subscription
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  
  subscriptionStatus     SubscriptionStatus @default(FREE)
  subscriptionTier        SubscriptionTier   @default(FREE)
  
  // Usage tracking
  invoiceCount           Int       @default(0)
  invoiceCountResetAt    DateTime  @default(now())
  
  // Billing
  billingCycle           BillingCycle?
  
  subscriptionEvents     SubscriptionEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customers         Customer[]
  invoices          Invoice[]
  products          Product[]
  emailSettings     EmailSettings?
  projects          Project[]
  timeEntries       TimeEntry[]
  activityTypes     ActivityType[]
  recurringInvoices RecurringInvoice[]

  // BTW relations
  expenses   Expense[]
  vatReports VATReport[]
  icpEntries ICPEntry[]

  // BTW settings
  vatRegistered Boolean   @default(true)
  vatScheme     VATScheme @default(REGULAR)

  // Analytics
  businessGoals      BusinessGoal[]
  analyticsSnapshots AnalyticsSnapshot[]

  // NextAuth sessions
  accounts Account[]
  sessions Session[]

  // Invitations
  sentInvitations     Invitation[] @relation("InvitationSender")
  receivedInvitation Invitation?  @relation("InvitationReceiver")
  
  // Audit logs
  auditLogs          AuditLog[]
}

model Customer {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  companyName String?
  email       String
  phone       String?

  address    String
  city       String
  postalCode String
  country    String @default("Nederland")

  vatNumber String? // BTW-nummer klant

  paymentTermDays Int     @default(30)
  notes           String?

  invoices          Invoice[]
  projects          Project[]
  timeEntries       TimeEntry[]
  recurringInvoices RecurringInvoice[]

  // BTW relations
  expenses   Expense[]
  icpEntries ICPEntry[]

  // BTW info
  vatCountry  String? // Land voor ICP
  vatReversed Boolean @default(false) // Verlegd BTW van toepassing

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Product {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?
  unitPrice   Decimal @db.Decimal(10, 2)
  vatRate     Decimal @default(21.00) @db.Decimal(5, 2) // 21%, 9%, 0%
  unit        String  @default("uur") // uur, stuk, dag, etc.
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Invoice {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  invoiceNumber String   @unique
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])

  invoiceDate DateTime      @default(now())
  dueDate     DateTime
  status      InvoiceStatus @default(DRAFT)

  // Bedragen
  subtotal  Decimal @db.Decimal(10, 2)
  vatAmount Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  // Extra velden
  reference     String? // Referentie klant
  notes         String? // Extra notities op factuur
  internalNotes String? // Interne notities (niet op PDF)

  // Items
  items InvoiceItem[]

  // Metadata
  pdfPath String?
  sentAt  DateTime?
  paidAt  DateTime?

  // Email tracking
  emails          EmailLog[]
  emailsSentCount Int        @default(0)
  lastEmailSentAt DateTime?

  // Recurring invoice relation
  recurringInvoiceId String?
  recurringInvoice   RecurringInvoice? @relation(fields: [recurringInvoiceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([customerId])
  @@index([status])
  @@index([invoiceDate])
  @@index([recurringInvoiceId])
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(10, 2)
  vatRate     Decimal @db.Decimal(5, 2)
  unit        String  @default("uur")

  // Berekend
  subtotal  Decimal @db.Decimal(10, 2) // quantity * unitPrice
  vatAmount Decimal @db.Decimal(10, 2) // subtotal * (vatRate / 100)
  total     Decimal @db.Decimal(10, 2) // subtotal + vatAmount

  sortOrder Int @default(0)

  // Time tracking relation (optional)
  timeEntry TimeEntry? @relation("TimeEntryToInvoiceItem")

  // Expense relation (optional)
  expense Expense?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
}

enum InvoiceStatus {
  DRAFT // Concept
  SENT // Verzonden
  PAID // Betaald
  OVERDUE // Achterstallig
  CANCELLED // Geannuleerd
}

enum EmailType {
  INVOICE // Nieuwe factuur
  REMINDER_FRIENDLY // Vriendelijke herinnering (voor vervaldatum)
  REMINDER_FIRST // 1e herinnering (na vervaldatum)
  REMINDER_SECOND // 2e herinnering
  REMINDER_FINAL // Finale herinnering
  PAYMENT_RECEIVED // Betaling ontvangen bevestiging
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  FAILED
  BOUNCED
}

model EmailLog {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  type      EmailType
  recipient String
  subject   String
  status    EmailStatus @default(PENDING)

  resendId String? // Resend email ID voor tracking
  error    String?

  sentAt    DateTime?
  openedAt  DateTime? // Via Resend webhooks
  clickedAt DateTime? // Via Resend webhooks

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([status])
  @@index([type])
}

model EmailSettings {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Auto-send settings
  autoSendInvoice        Boolean @default(false)
  autoSendReminders      Boolean @default(false)
  autoSendPaymentConfirm Boolean @default(true)

  // Reminder timing
  friendlyReminderDays Int @default(-3) // 3 dagen voor vervaldatum
  firstReminderDays    Int @default(7) // 7 dagen na vervaldatum
  secondReminderDays   Int @default(14)
  finalReminderDays    Int @default(30)

  // Template customization
  companyLogo    String?
  emailSignature String?
  invoiceEmailCc String? // CC alle factuur emails

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Time Tracking Models

model Project {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  name        String
  description String?
  code        String? // Project code voor referentie
  color       String? // Kleur voor visuele identificatie

  status ProjectStatus @default(ACTIVE)

  // Budget tracking
  budgetHours  Decimal? @db.Decimal(10, 2)
  budgetAmount Decimal? @db.Decimal(10, 2)

  // Default rates
  defaultHourlyRate Decimal? @db.Decimal(10, 2)

  // Dates
  startDate DateTime?
  endDate   DateTime?

  // Relations
  timeEntries TimeEntry[]
  expenses    Expense[]

  // Metadata
  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([customerId])
  @@index([status])
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

model TimeEntry {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  invoiceItemId String?      @unique
  invoiceItem   InvoiceItem? @relation("TimeEntryToInvoiceItem", fields: [invoiceItemId], references: [id])

  // Time tracking
  description String

  startTime DateTime
  endTime   DateTime?

  duration Decimal @db.Decimal(10, 2) // in uren (bijv 1.5 = 1u 30min)

  // Running timer
  isRunning Boolean @default(false)

  // Billing
  billable   Boolean @default(true)
  hourlyRate Decimal @db.Decimal(10, 2)
  amount     Decimal @db.Decimal(10, 2) // duration * hourlyRate

  // Status
  invoiced Boolean @default(false)

  // Metadata
  activityType String? // Development, Meeting, Research, Support, etc.
  notes        String? // Interne notities
  tags         String[] // Voor filtering/grouping

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([customerId])
  @@index([projectId])
  @@index([startTime])
  @@index([billable])
  @@index([invoiced])
  @@index([isRunning])
}

model ActivityType {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?
  color       String?
  icon        String? // Lucide icon name
  billable    Boolean @default(true) // Default billable status

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

// Recurring Invoices Models

model RecurringInvoice {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Naming
  name        String // "Retainer Q1 2025", "Hosting Package"
  description String?
  reference   String? // Contract nummer

  // Scheduling
  frequency RecurringFrequency
  interval  Int                @default(1) // Elke X maanden/weken

  startDate DateTime
  endDate   DateTime?
  nextDate  DateTime // Volgende generatie datum
  lastDate  DateTime? // Laatste keer gegenereerd

  // Status
  status RecurringStatus @default(ACTIVE)

  // Billing details
  dayOfMonth Int? // Voor monthly: dag van de maand (1-28)

  // Auto-send
  autoSend Boolean @default(false)
  sendDays Int     @default(0) // Dagen na generatie voor verzending

  // Items template
  items RecurringInvoiceItem[]

  // Pricing history
  priceChanges RecurringPriceChange[]

  // Generated invoices
  invoices Invoice[]

  // Logs
  logs RecurringInvoiceLog[]

  // Metadata
  notes    String? // Interne notities
  contract String? // PDF path naar contract

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([customerId])
  @@index([status])
  @@index([nextDate])
}

enum RecurringFrequency {
  WEEKLY
  BIWEEKLY // Tweewekelijks
  MONTHLY
  QUARTERLY
  BIANNUAL // Halfjaarlijks
  ANNUAL
}

enum RecurringStatus {
  ACTIVE // Actief, genereert facturen
  PAUSED // Gepauzeerd
  ENDED // Afgelopen (einddatum bereikt)
  CANCELLED // Geannuleerd
}

model RecurringInvoiceItem {
  id                 String           @id @default(cuid())
  recurringInvoiceId String
  recurringInvoice   RecurringInvoice @relation(fields: [recurringInvoiceId], references: [id], onDelete: Cascade)

  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(10, 2)
  vatRate     Decimal @db.Decimal(5, 2)

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recurringInvoiceId])
}

model RecurringPriceChange {
  id                 String           @id @default(cuid())
  recurringInvoiceId String
  recurringInvoice   RecurringInvoice @relation(fields: [recurringInvoiceId], references: [id], onDelete: Cascade)

  effectiveDate DateTime
  oldAmount     Decimal  @db.Decimal(10, 2)
  newAmount     Decimal  @db.Decimal(10, 2)
  reason        String?

  applied   Boolean   @default(false)
  appliedAt DateTime?

  createdBy String // User ID die wijziging maakte
  createdAt DateTime @default(now())

  @@index([recurringInvoiceId])
  @@index([effectiveDate])
}

model RecurringInvoiceLog {
  id                 String           @id @default(cuid())
  recurringInvoiceId String
  recurringInvoice   RecurringInvoice @relation(fields: [recurringInvoiceId], references: [id], onDelete: Cascade)

  action    RecurringLogAction
  invoiceId String? // Als actie een factuur genereerde

  details   String?
  createdBy String? // User ID
  createdAt DateTime @default(now())

  @@index([recurringInvoiceId])
  @@index([createdAt])
}

enum RecurringLogAction {
  CREATED
  ACTIVATED
  PAUSED
  RESUMED
  CANCELLED
  ENDED
  INVOICE_GENERATED
  PRICE_CHANGED
  SCHEDULE_UPDATED
}

// BTW Reporting Models

model Expense {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  date        DateTime
  description String
  category    ExpenseCategory

  // Amounts
  amount    Decimal @db.Decimal(10, 2) // Inclusief BTW
  vatAmount Decimal @db.Decimal(10, 2)
  vatRate   Decimal @db.Decimal(5, 2)
  netAmount Decimal @db.Decimal(10, 2) // Exclusief BTW

  // Supplier info
  supplier      String?
  invoiceNumber String?

  // Deductibility
  deductible     Boolean @default(true)
  deductiblePerc Decimal @default(100) @db.Decimal(5, 2) // Percentage aftrekbaar

  // Receipt
  receipt String? // File path naar scan/foto

  // Relations
  customerId String? // Als doorbelast aan klant
  customer   Customer? @relation(fields: [customerId], references: [id])

  projectId String? // Koppel aan project
  project   Project? @relation(fields: [projectId], references: [id])

  invoiced      Boolean      @default(false) // Doorbelast op factuur
  invoiceItemId String?      @unique
  invoiceItem   InvoiceItem? @relation(fields: [invoiceItemId], references: [id])

  // Metadata
  notes String?
  tags  String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([date])
  @@index([category])
  @@index([deductible])
}

enum ExpenseCategory {
  OFFICE // Kantoorkosten
  TRAVEL // Reiskosten
  EQUIPMENT // Apparatuur
  SOFTWARE // Software/subscriptions
  MARKETING // Marketing
  EDUCATION // Opleiding
  INSURANCE // Verzekeringen
  ACCOUNTANT // Accountant/administratie
  TELECOM // Telefoon/internet
  UTILITIES // Energie
  RENT // Huur
  MAINTENANCE // Onderhoud
  PROFESSIONAL // Professionele diensten
  OTHER // Overig
}

model VATReport {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Period
  year      Int
  quarter   Int // 1, 2, 3, 4
  startDate DateTime
  endDate   DateTime

  // Revenue (Omzet)
  revenueHighRate Decimal @db.Decimal(10, 2) // 21%
  revenueHighVAT  Decimal @db.Decimal(10, 2)

  revenueLowRate Decimal @db.Decimal(10, 2) // 9%
  revenueLowVAT  Decimal @db.Decimal(10, 2)

  revenueZeroRate Decimal @db.Decimal(10, 2) // 0%

  revenueReversed Decimal @db.Decimal(10, 2) // Verlegd
  revenueEU       Decimal @db.Decimal(10, 2) // ICP
  revenueExport   Decimal @db.Decimal(10, 2) // Export buiten EU

  totalRevenue    Decimal @db.Decimal(10, 2)
  totalRevenueVAT Decimal @db.Decimal(10, 2)

  // Expenses (Inkopen/Kosten)
  expensesHighRate Decimal @db.Decimal(10, 2)
  expensesHighVAT  Decimal @db.Decimal(10, 2)

  expensesLowRate Decimal @db.Decimal(10, 2)
  expensesLowVAT  Decimal @db.Decimal(10, 2)

  expensesReversed Decimal @db.Decimal(10, 2) // Verlegd ontvangen

  totalExpenses    Decimal @db.Decimal(10, 2)
  totalExpensesVAT Decimal @db.Decimal(10, 2)

  // Calculation
  vatOwed       Decimal @db.Decimal(10, 2) // Te betalen
  vatDeductible Decimal @db.Decimal(10, 2) // Aftrekbaar
  vatBalance    Decimal @db.Decimal(10, 2) // Saldo (owes - deductible)

  // Status
  status    VATReportStatus @default(DRAFT)
  filedDate DateTime?

  // Adjustments/Corrections
  adjustments VATAdjustment[]

  // Metadata
  notes       String?
  generatedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, year, quarter])
  @@index([userId])
  @@index([year, quarter])
}

enum VATReportStatus {
  DRAFT
  FINAL
  FILED // Ingediend bij Belastingdienst
}

model VATAdjustment {
  id       String    @id @default(cuid())
  reportId String
  report   VATReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  description String
  amount      Decimal @db.Decimal(10, 2)
  reason      String?

  createdAt DateTime @default(now())

  @@index([reportId])
}

model ICPEntry {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Period
  year    Int
  quarter Int

  // Customer (EU business)
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Amounts
  amount Decimal @db.Decimal(10, 2) // Totaal voor deze klant dit kwartaal

  // Metadata
  invoiceIds String[] // Factuur IDs voor referentie

  createdAt DateTime @default(now())

  @@unique([userId, year, quarter, customerId])
  @@index([userId])
  @@index([year, quarter])
  @@index([customerId])
}

enum VATScheme {
  REGULAR // Reguliere regeling
  SMALL // Kleine ondernemersregeling (KOR)
  MARGIN // Margeregeling
}

// Analytics Models

model BusinessGoal {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type   GoalType
  period GoalPeriod

  // Target values
  targetRevenue Decimal? @db.Decimal(10, 2)
  targetProfit  Decimal? @db.Decimal(10, 2)
  targetHours   Decimal? @db.Decimal(10, 2)
  targetClients Int?

  // Period
  year    Int
  quarter Int? // Voor quarterly goals
  month   Int? // Voor monthly goals

  // Tracking
  achieved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type, period, year, quarter, month])
  @@index([userId])
}

enum GoalType {
  REVENUE
  PROFIT
  HOURS
  CLIENTS
}

enum GoalPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

model AnalyticsSnapshot {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date DateTime

  // Daily metrics
  revenue  Decimal @db.Decimal(10, 2)
  expenses Decimal @db.Decimal(10, 2)
  profit   Decimal @db.Decimal(10, 2)

  // Counts
  invoicesSent   Int
  invoicesPaid   Int
  newCustomers   Int
  activeProjects Int

  // Hours
  hoursLogged   Decimal @db.Decimal(10, 2)
  billableHours Decimal @db.Decimal(10, 2)

  // Outstanding
  outstanding Decimal @db.Decimal(10, 2)
  overdue     Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

enum UserRole {
  USER
  ADMIN
  SUPERUSER
}

enum SubscriptionStatus {
  FREE
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

enum SubscriptionTier {
  FREE
  PRO
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionEventType {
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_DELETED
  SUBSCRIPTION_TRIAL_ENDING
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  INVOICE_PAID
  INVOICE_PAYMENT_FAILED
}

enum WatermarkPosition {
  DIAGONAL      // Diagonaal over de pagina
  CENTER        // Gecentreerd
  BOTTOM        // Onderaan
  TOP           // Bovenaan
  FOOTER        // In footer sectie
}

model SystemSettings {
  id          String   @id @default("default")

  // Watermark settings
  watermarkEnabled        Boolean  @default(true)
  watermarkText           String   @default("GRATIS VERSIE - Upgrade naar Pro op app.yoursite.com")
  watermarkOpacity        Decimal  @db.Decimal(3, 2) @default(0.15)
  watermarkRotation       Int      @default(-45) // degrees
  watermarkFontSize       Int      @default(40)
  watermarkColor          String   @default("#999999")
  watermarkPosition       WatermarkPosition @default(DIAGONAL)

  // Feature toggles
  freeUserWatermarkEnabled Boolean @default(true)

  // Metadata
  updatedAt   DateTime @updatedAt
  updatedBy   String?  // User ID who made the change

  @@unique([id]) // Ensure only one settings record
}

model SubscriptionEvent {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        SubscriptionEventType
  
  // Stripe data
  stripeEventId String  @unique
  
  // Metadata
  metadata    Json?
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// User Invitations Model

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

model Invitation {
  id          String   @id @default(cuid())
  
  // Sender (admin/owner)
  senderId    String
  sender      User     @relation("InvitationSender", fields: [senderId], references: [id], onDelete: Cascade)
  
  // Receiver (invited user)
  receiverId  String?  @unique
  receiver    User?    @relation("InvitationReceiver", fields: [receiverId], references: [id], onDelete: SetNull)
  
  // Invitation details
  email       String
  token       String   @unique // Unique token for invitation link
  status      InvitationStatus @default(PENDING)
  
  // Role for the invited user
  role        UserRole @default(USER)
  
  // Expiration
  expiresAt   DateTime
  acceptedAt  DateTime?
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([senderId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
}

// Audit Trail Model
model AuditLog {
  id          String   @id @default(cuid())
  timestamp   DateTime @default(now())
  
  // User information (snapshot for deleted users)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userEmail   String   // Snapshot of email at time of action
  
  // Action details
  action      AuditAction
  entityType  String   // invoice, customer, product, settings, etc.
  entityId    String?  // ID of the affected record
  
  // Change tracking
  changes     Json?    // { field: { oldValue, newValue } }
  
  // Request context
  ipAddress   String?
  userAgent   String?
  sessionId   String?
  
  // Additional metadata
  metadata    Json?    // Extra context (export format, print action, etc.)
  
  // Compliance features
  previousHash String? // Hash of previous log entry for chain integrity
  hash         String  // Hash of this log entry
  
  // Fraud detection flags
  isSuspicious Boolean @default(false)
  suspiciousReason String?
  
  createdAt   DateTime @default(now())
  
  @@index([timestamp])
  @@index([userId])
  @@index([userEmail])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([entityType, entityId])
  @@index([isSuspicious])
  @@index([createdAt])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PAYMENT_RECORDED
  INVOICE_SENT
  SETTINGS_CHANGED
  PASSWORD_CHANGED
  TWO_FA_ENABLED
  TWO_FA_DISABLED
}
